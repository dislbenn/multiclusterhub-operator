name: Generate Onboarded Requested Component

on:
  workflow_dispatch: {}
  pull_request_target:
    types: [opened, synchronize, reopened]
    paths:
      - onboard-request.yaml
 
jobs: 
  onboard-component:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout the repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}

      # Install yq
      - name: Install yq
        run: |
          wget https://github.com/mikefarah/yq/releases/download/v4.15.1/yq_linux_amd64 -O /usr/local/bin/yq
          chmod +x /usr/local/bin/yq

      - name: Parse onboarding request details
        id: parse_yaml
        env:
          CONFIG_FILE: onboard-request.yaml
        run: |
          # Parse YAML using yq and extract needed fields
          yq e '.components | keys | .[]' "$CONFIG_FILE" | while read -r c_index; do
              echo "Component: $c_index"
              component_yaml=$(yq e ".components[$c_index]" $CONFIG_FILE)
              
              echo "$component_yaml" | yq e '.operators | keys | .[]' - | while read -r o_index; do
                  OPERATOR_NAME=$(echo "$component_yaml" | yq e ".operators[$o_index].name" -)
                  OPERATOR_DESCRIPTION=$(echo "$component_yaml" | yq e ".operators[$o_index].description" -)
                  OPERATOR_ENABLED=$(echo "$component_yaml" | yq e ".operators[$o_index].enabled-by-default" -)
                  
                  echo "OPERATOR_NAME=$OPERATOR_NAME"
                  echo "OPERATOR_DESCRIPTION=$OPERATOR_DESCRIPTION"
                  echo "OPERATOR_ENABLED=$OPERATOR_ENABLED"
              done
          done

      - name: Add component entry to config file
        run: |
          echo "Attempting to add"

      - name: Insert component description into available-components doc
        run: |
          echo "Inserting $COMPONENT_NAME description into docs/available-components.md"

      - name: (Upstream) Validate image mapping
        run: |
          echo "Validating $COMPONENT_NAME upstream image mapping"

      - name: (Downstream) Validate image mapping
        run: |
          echo "Validating $COMPONENT_NAME downstream image mapping"

      - name: Build Component
        run: |
          echo "Building $COMPONENT_NAME component"
