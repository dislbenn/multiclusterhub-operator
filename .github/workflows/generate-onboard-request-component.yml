name: Generate Onboarded Requested Component

on:
  workflow_dispatch: {}
  pull_request_target:
    types: [opened, synchronize, reopened]
    paths:
      - onboard-request.yaml

jobs: 
  onboard-component:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout the repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}

      - name: Parse onboarding request details
        id: parse_yaml
        run: |
          # Parse YAML using yq and extract needed fields
          ls -la
          CONFIG_FILE="onboard-request.yaml"

          for i in $(yq e '.operators | keys | .[]' $CONFIG_FILE); do
            OPERATOR_NAME=$(yq e ".operators[$i].name" $CONFIG_FILE)
            OPERATOR_DESCRIPTION=$(yq e ".operators[$i].description // \"No description available\"" $CONFIG_FILE)
            OPERATOR_ENABLED=$(yq e ".operators[$i].enabled // false" $CONFIG_FILE)

            echo "OPERATOR_NAME=$OPERATOR_NAME" >> $GITHUB_ENV
            echo "OPERATOR_DESCRIPTION=$OPERATOR_DESCRIPTION" >> $GITHUB_ENV
            echo "OPERATOR_ENABLED=$OPERATOR_ENABLED" >> $GITHUB_ENV

      - name: Add component entry to config file
        run: |
          echo "Attempting to add"

      - name: Insert component description into available-components doc
        run: |
          echo "Inserting $COMPONENT_NAME description into docs/available-components.md"

      - name: (Upstream) Validate image mapping
        run: |
          echo "Validating $COMPONENT_NAME upstream image mapping"

      - name: (Downstream) Validate image mapping
        run: |
          echo "Validating $COMPONENT_NAME downstream image mapping"

      - name: Build Component
        run: |
          echo "Building $COMPONENT_NAME component"